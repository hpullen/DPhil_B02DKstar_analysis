# Make rho efficiency table
rule rho_efficiency_table:
    output: 
        expand("/home/pullen/analysis/B02DKstar/ANA_resources/Tables/Backgrounds/rho_efficiency_{mode}_run{run_num}.tex",
               run_num = ["1", "2"], mode = ["Kpi", "Kpipipi"])
    input:
        "/home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Backgrounds/make_rho_table.sh",
        expand("/home/pullen/analysis/B02DKstar/Efficiencies/Values/{eff}_efficiency_rho_run{run_num}.param",
               eff = ["acceptance", "selection", "PID"], run_num = ["1", "2"])
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Backgrounds/;"
        "./make_rho_table.sh"

# Make average efficiency files for rho
rule rho_acceptance_efficiency:
    output:
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/acceptance_efficiency_rho_run1.param",
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/acceptance_efficiency_rho_run2.param"
    input:
        "/home/pullen/analysis/B02DKstar/Efficiencies/Generator/rho/Kpi.param"
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/Scripts/;"
        "./acceptance_efficiency_rho.sh"

rule rho_selection_efficiency:
    output:
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/selection_efficiency_rho_run1.param",
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/selection_efficiency_rho_run2.param",
    input:
        expand("/data/lhcb/users/pullen/B02DKstar/MC/backgrounds/rho/{year}_{mag}/Kpi_selected.root", year = ["2012", "2016"], mag = ["up", "down"]),
        expand("/data/lhcb/users/pullen/B02DKstar/MC/backgrounds/rho_Kpipipi/{year}_{mag}/Kpipipi_selected.root", year = ["2012", "2016"], mag = ["up", "down"])
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/Selection/;"
        "./RhoSelectionEfficiency;"
        "./RhoSelectionEfficiency _Kpipipi;"
        "cd ../Scripts;"
        "./selection_efficiency_rho.sh"

rule rho_PID_efficiency:
    output:
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/PID_efficiency_rho_run1.param",
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/PID_efficiency_rho_run2.param"
    input:
        expand("/data/lhcb/users/pullen/B02DKstar/PIDCalib/Results/{year}_{mag}/rho{mode}_withPIDeffs.root",
               year = ["2012", "2016"], mag = ["up", "down"], mode = ["", "_Kpipipi"])
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/PID/Efficiency_calculations/;"
        "./process_rho.sh;"
        "./process_rho.sh _Kpipipi;"
        "cd ../../Scripts;"
        "./PID_efficiency_rho.sh"


# Plot comparing mass before and after PID cut
rule rho_PID_plot:
    output: 
        "/home/pullen/analysis/B02DKstar/ANA_resources/Plots/Backgrounds/rho_with_PID.pdf"
    input:
        expand("/data/lhcb/users/pullen/B02DKstar/MC/backgrounds/rho/{year}_{mag}/Kpi_selected_resampled.root",
               year = ["2016"], mag = ["up", "down"]),
        "/home/pullen/analysis/B02DKstar/Backgrounds/rho/plot_rho_after_PID_cut.C"
    shell:
        "cd /home/pullen/analysis/B02DKstar/Backgrounds/rho;"
        "root -b -q plot_rho_after_PID_cut.C;"
        "cp cut_rho_normalized.pdf {output}"


# Table with PID efficiencies only
rule rho_PID_table:
    input: 
        expand("/home/pullen/analysis/B02DKstar/Efficiencies/Values/{eff}_efficiency_rho_run{run_num}.param",
               eff = ["PID"], run_num = ["1", "2"]),
        "/home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Backgrounds/make_rho_PID_table.sh"
    output:
        "/home/pullen/analysis/B02DKstar/ANA_resources/Tables/Backgrounds/rho_PID.tex",
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Backgrounds/;"
        "./make_rho_PID_table.sh"
