# Count events in bookkeeping
rule count_signal_bookkeeping_events:
    input:
        expand("/data/lhcb/users/pullen/gangadir/job_output/MC/twoBody/{mode}/"
               "{year}_{mag}/", mode = ["Kpi", "KK", "pipi"], mag = ["up", "down"],
               year = ["2012", "2015", "2016"]),
        expand("/data/lhcb/users/pullen/gangadir/job_output/MC/twoBody/Kpi/"
               "2011_{mag}/", mag = ["up", "down"]),
        expand("/data/lhcb/users/pullen/gangadir/job_output/MC/fourBody/{mode}/"
               "2016_{mag}/", mode = ["Kpipipi", "pipipipi"], mag = ["up", "down"]),
        expand("/data/lhcb/users/pullen/gangadir/job_output/MC/fourBody/Kpipipi/"
               "2012_{mag}/", mag = ["up", "down"]),
        expand("/data/lhcb/users/pullen/gangadir/job_output/MC/backgrounds/lowMass/"
               "{particle}/{hel}/{year}_{mag}/", mag = ["up", "down"],
               year = ["2012", "2016"], particle = ["gamma", "pi"], 
               hel = ["010", "100", "100"]),
        "/home/pullen/analysis/B02DKstar/Efficiencies/Selection/count_events.sh"
    output:
        "/home/pullen/analysis/B02DKstar/Efficiencies/Selection/Results/n_bookkeeping.txt",
        "/home/pullen/analysis/B02DKstar/Efficiencies/Selection/Results/n_bookkeeping_lowMass.txt"
    shell:
        "sh /home/pullen/analysis/B02DKstar/Efficiencies/Selection/count_events.sh"


# Calculate selection efficiencies for each sample
rule calculate_selection_efficiencies_separate:
    input:
        expand("/data/lhcb/users/pullen/B02DKstar/MC/twoBody/{mode}/"
               "{year}_{mag}/{mode}_selected.root", mode = ["Kpi", "KK", "pipi"], 
               mag = ["up", "down"], year = ["2012", "2015", "2016"]),
        expand("/data/lhcb/users/pullen/B02DKstar/MC/twoBody/Kpi/"
               "2011_{mag}/Kpi_selected.root", mag = ["up", "down"]),
        expand("/data/lhcb/users/pullen/B02DKstar/MC/fourBody/{mode}/"
               "2016_{mag}/{mode}_selected.root", mode = ["Kpipipi", "pipipipi"], 
               mag = ["up", "down"]),
        expand("/data/lhcb/users/pullen/B02DKstar/MC/fourBody/Kpipipi/"
               "2012_{mag}/Kpipipi_selected.root", mag = ["up", "down"]),
        "/home/pullen/analysis/B02DKstar/Efficiencies/Selection/SelectionEfficiency"
    output:
        expand("/home/pullen/analysis/B02DKstar/Efficiencies/Selection/Results/"
               "{mode}.param", mode = ["Kpi", "KK", "pipi", "Kpipipi", "pipipipi"])
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/Selection/; ./SelectionEfficiency"

# Average selection efficiencies
rule average_selection_efficiency:
    input:
        expand("/home/pullen/analysis/B02DKstar/Efficiencies/Selection/Results/"
               "{mode}.param", mode = ["Kpi", "KK", "pipi", "Kpipipi", "pipipipi"])
    output:
        expand("/home/pullen/analysis/B02DKstar/Efficiencies/Values/selection_efficiency{run_num}.param", run_num = ["", "_run1", "_run2"])
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/Scripts/;"
        "./selection_efficiencies.sh"

# Average acceptance efficiencies
rule average_acceptance_efficiency:
    input:
        expand("/home/pullen/analysis/B02DKstar/Efficiencies/Generator/Results/"
               "{mode}.param", mode = ["Kpi", "KK", "pipi", "Kpipipi", "pipipipi"])
    output:
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/acceptance_efficiency.param"
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/Scripts/;"
        "./acceptance_efficiency.sh"

# Make table
rule make_selection_efficiency_table:
    input:
        expand("/home/pullen/analysis/B02DKstar/Efficiencies/Values/{eff}_efficiency_{run_num}.param",
                eff = ["selection", "acceptance", "total"], run_num = ["run1", "run2"]),
        "/home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Monte_carlo/make_selection_efficiency_table.sh"
    output:
        expand("/home/pullen/analysis/B02DKstar/ANA_resources/Tables/Monte_carlo/selection_efficiency_{run_num}.tex",
                run_num = ["run1", "run2"])
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Monte_carlo/;"
        "./make_selection_efficiency_table.sh run1;"
        "./make_selection_efficiency_table.sh run2;"

# Get selection efficiency for low mass
rule selection_efficiency_lowMass:
    input:
        expand("/data/lhcb/users/pullen/B02DKstar/MC/backgrounds/lowMass/{particle}/{hel}/{year}_{mag}/Kpi_selected.root",
               particle = ["gamma", "pi"], hel = ["010", "100", "001"], year = ["2012", "2016"], mag = ["up", "down"])
    output:
        expand("/home/pullen/analysis/B02DKstar/Efficiencies/Values/selection_lowMass_run{run_num}.param",
               run_num = ["1", "2"])
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/Selection/;"
        "./LowMassSelectionEfficiency;"
        "cd ../Scripts;"
        "./selection_efficiency_lowMass.sh"

# Bs efficiencies
# Average selection efficiencies
rule Bs_selection_efficiency:
    input:
        expand("/data/lhcb/users/pullen/B02DKstar/MC/backgrounds/Bs/{year}_{mag}/Kpi_selected.root",
               year = ["2011", "2012", "2015", "2016"], mag = ["up", "down"])
    output:
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/selection_efficiency_Bs_run1.param",
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/selection_efficiency_Bs_run2.param"
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/Selection/;"
        "./BsSelectionEfficiency;"
        "cd ../Scripts/;"
        "./selection_efficiency_Bs.sh"

# Average acceptance efficiencies
rule Bs_acceptance_efficiency:
    input:
        "/home/pullen/analysis/B02DKstar/Efficiencies/Generator/Bs.param"
    output:
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/acceptance_efficiency_Bs_run1.param",
        "/home/pullen/analysis/B02DKstar/Efficiencies/Values/acceptance_efficiency_Bs_run2.param"
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/Scripts/;"
        "./acceptance_efficiency_Bs.sh"

# Make table
rule make_Bs_selection_efficiency_table:
    input:
        expand("/home/pullen/analysis/B02DKstar/Efficiencies/Values/{eff}_efficiency_Bs_{run_num}.param",
                eff = ["selection", "acceptance"], run_num = ["run1", "run2"]),
        "/home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Monte_carlo/make_Bs_selection_efficiency_table.sh"
    output:
        "/home/pullen/analysis/B02DKstar/ANA_resources/Tables/Monte_carlo/selection_efficiency_Bs.tex"
    shell:
        "cd /home/pullen/analysis/B02DKstar/Efficiencies/Scripts/;"
        "./total_efficiency.sh Bs;"
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Monte_carlo/;"
        "./make_Bs_selection_efficiency_table.sh"

