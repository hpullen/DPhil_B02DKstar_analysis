# Plot locations
plots_others= expand("/home/pullen/analysis/B02DKstar/Fit_data/Plots/"
               "twoAndFourBody_data_split_{mode}_run{run_num}_{sign}.pdf", mode = ["Kpi", "piK", 
               "KK", "pipi", "Kpipipi", "piKpipi"],
               sign = ["plus", "minus"], run_num = ["1", "2"])
plots_pipipipi= expand("/home/pullen/analysis/B02DKstar/Fit_data/Plots/"
               "twoAndFourBody_data_split_pipipipi_run2_{sign}.pdf", 
               sign = ["plus", "minus"])
plots_others_combined= expand("/home/pullen/analysis/B02DKstar/Fit_data/Plots/"
                              "twoAndFourBody_data_{mode}_run{run_num}.pdf", mode = ["Kpi", "piK", 
                              "KK", "pipi", "Kpipipi", "piKpipi"],
                              run_num = ["1", "2"])
plots_pipipipi_combined = "/home/pullen/analysis/B02DKstar/Fit_data/Plots/twoAndFourBody_data_split_pipipipi_run2.pdf"


# Perform fit to data
rule data_fit_split:
    input:
        # Selected data nTuples
        expand("/data/lhcb/users/pullen/B02DKstar/data/twoBody/{year}_{mag}/"
               "{mode}_selected.root", year = ["2011", "2012", "2015", "2016"],
               mag = ["up", "down"], mode = ["Kpi", "piK", "KK", "pipi"]),
        expand("/data/lhcb/users/pullen/B02DKstar/data/fourBody/{year}_{mag}/"
               "{mode}_selected.root", year = ["2011", "2012", "2015", "2016"],
               mag = ["up", "down"], mode = ["Kpipipi", "piKpipi"]),
        expand("/data/lhcb/users/pullen/B02DKstar/data/fourBody/{year}_{mag}/"
               "pipipipi_selected.root", year = ["2015", "2016"], mag = ["up", "down"]),
        
        # Monte Carlo fit parameters
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/signal_Kpi.param",
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/signal_Kpipipi.param",
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/signal_Bs.param",
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/lowMass.param",
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/rho.param",

        # Executable
        "/home/pullen/analysis/B02DKstar/Fit_data/FitData"

    output:
        # Fit result
        "/home/pullen/analysis/B02DKstar/Fit_data/Results/twoAndFourBody_data_split.root",

        # Plots
        plots_others,
        plots_pipipipi

    shell:
        "cd /home/pullen/analysis/B02DKstar/Fit_data/; ./FitData --split"


# Flavour combined fit
rule data_fit_combined:
    input:
        # Selected data nTuples
        expand("/data/lhcb/users/pullen/B02DKstar/data/twoBody/{year}_{mag}/"
               "{mode}_selected.root", year = ["2011", "2012", "2015", "2016"],
               mag = ["up", "down"], mode = ["Kpi", "piK", "KK", "pipi"]),
        expand("/data/lhcb/users/pullen/B02DKstar/data/fourBody/{year}_{mag}/"
               "{mode}_selected.root", year = ["2011", "2012", "2015", "2016"],
               mag = ["up", "down"], mode = ["Kpipipi", "piKpipi"]),
        expand("/data/lhcb/users/pullen/B02DKstar/data/fourBody/{year}_{mag}/"
               "pipipipi_selected.root", year = ["2015", "2016"], mag = ["up", "down"]),
        
        # Monte Carlo fit parameters
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/signal_Kpi.param",
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/signal_Kpipipi.param",
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/signal_Bs.param",
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/lowMass.param",
        "/home/pullen/analysis/B02DKstar/Fit_monte_carlo/Results/rho.param",

        # Executable
        "/home/pullen/analysis/B02DKstar/Fit_data/FitData"

    output:
        # Fit result
        "/home/pullen/analysis/B02DKstar/Fit_data/Results/twoAndFourBody_data.root",

        # Plots
        plots_others_combined,
        plots_pipipipi_combined

    shell:
        "cd /home/pullen/analysis/B02DKstar/Fit_data/; ./FitData --split"



# Copy plots to ANA resources
# ANA plot locations
ANA_plots_others = expand("/home/pullen/analysis/B02DKstar/ANA_resources/Plots/Data_fit/"
               "twoAndFourBody_data_split_{mode}_run{run_num}_{sign}.pdf", mode = ["Kpi", "piK", 
               "KK", "pipi", "Kpipipi", "piKpipi"],
               sign = ["plus", "minus"], run_num = ["1", "2"])
ANA_plots_pipipipi = expand("/home/pullen/analysis/B02DKstar/ANA_resources/Plots/Data_fit/"
               "twoAndFourBody_data_split_pipipipi_run2_{sign}.pdf", 
               sign = ["plus", "minus"])
ANA_plots_others_combined = expand("/home/pullen/analysis/B02DKstar/ANA_resources/Plots/Data_fit/"
                                   "twoAndFourBody_data_{mode}_run{run_num}.pdf", mode = ["Kpi", "piK", 
                                   "KK", "pipi", "Kpipipi", "piKpipi"], run_num = ["1", "2"])
ANA_plots_pipipipi_combined = "/home/pullen/analysis/B02DKstar/ANA_resources/Plots/Data_fit/twoAndFourBody_data_pipipipi_run2.pdf"

rule copy_data_fit_plots:
    input:
        plots_others,
        plots_pipipipi
    output:
        ANA_plots_others,
        ANA_plots_pipipipi
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Plots/Data_fit/;"
        "./get_data_plots.sh"


rule copy_data_fit_plots_combined:
    input:
        plots_others_combined,
        plots_pipipipi_combined
    output:
        ANA_plots_others_combined,
        ANA_plots_pipipipi_combined
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Plots/Data_fit/;"
        "./get_data_plots.sh --combined"


# Make fit results table
rule data_fit_result_table:
    input:
        "/home/pullen/analysis/B02DKstar/Fit_data/Results/twoAndFourBody_data_split.root",
        "/home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Data_fit/make_fit_result_table.sh",
        "/home/pullen/analysis/B02DKstar/ANA_scripts/names.param"
    output:
        "/home/pullen/analysis/B02DKstar/ANA_resources/Tables/Data_fit/fit_result.tex"
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Data_fit;"
        "root -b -q fit_result_file.C;"
        "./make_fit_result_table.sh"


# Make LaTeX tables of data fit plots 
rule make_latex_fit_plots:
    input:
        "/home/pullen/analysis/B02DKstar/ANA_scripts/Plots/Data_fit/make_plot_input.sh"
    output: 
        "/home/pullen/analysis/B02DKstar/ANA_resources/Plots/Data_fit/data_fit_plots.tex"
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Plots/Data_fit;"
        "./make_plot_input.sh"


# Make LaTeX tables of combineddata fit plots 
rule make_latex_fit_plots_combined:
    input:
        "/home/pullen/analysis/B02DKstar/ANA_scripts/Plots/Data_fit/make_plot_input.sh"
    output: 
        "/home/pullen/analysis/B02DKstar/ANA_resources/Plots/Data_fit/data_fit_plots_combined.tex"
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Plots/Data_fit;"
        "./make_plot_input.sh --combined"


# Print number of free parameters to a file
rule print_free_params_number:
    input:
        "/home/pullen/analysis/B02DKstar/Fit_data/Results/twoAndFourBody_data_split.root"
    output:
        "/home/pullen/analysis/B02DKstar/ANA_resources/Tables/Fit_setup/Values/n_params.tex"
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Fit_setup/;"
        "root -b -q GetNParameters.C"


# Make fit results table combined
rule data_fit_result_table_combined:
    input:
        "/home/pullen/analysis/B02DKstar/Fit_data/Results/twoAndFourBody_data.root",
        "/home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Data_fit/make_fit_result_table.sh",
        "/home/pullen/analysis/B02DKstar/ANA_scripts/names.param"
    output:
        "/home/pullen/analysis/B02DKstar/ANA_resources/Tables/Data_fit/fit_result_combined.tex"
    shell:
        "cd /home/pullen/analysis/B02DKstar/ANA_scripts/Tables/Data_fit;"
        "root -b -q fit_result_file.C;"
        "./make_fit_result_table.sh --combined"

